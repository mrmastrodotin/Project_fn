<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project FN - Cognitive Check-up</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FFFFFF",
                        "background-dark": "#0A0A0A",
                        "card-dark": "#1A232C",
                        "accent-blue": "#38BDF8",
                        "accent-green": "#34D399",
                        "accent-purple": "#A78BFA"
                    },
                    fontFamily: {
                        display: "Manrope"
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    },
                    animation: {
                        "fade-in-up": "fadeInUp 0.8s ease-out forwards",
                        "fade-in-down": "fadeInDown 0.6s ease-out forwards",
                        "slide-in-left": "slideInLeft 1s ease-out forwards"
                    },
                    keyframes: {
                        fadeInUp: {
                            "0%": { opacity: "0", transform: "translateY(20px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        },
                        fadeInDown: {
                            "0%": { opacity: "0", transform: "translateY(-20px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" }
                        },
                        slideInLeft: {
                            "0%": { opacity: "0", transform: "translateX(50px)" },
                            "100%": { opacity: "1", transform: "translateX(0)" }
                        }
                    }
                }
            }
        };
    </script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Manrope', sans-serif;
            min-height: 100dvh;
            background-color: #0A0A0A;
            color: #FFFFFF;
            overflow-x: hidden;
        }
        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-400 { animation-delay: 0.4s; }
        .animate-delay-600 { animation-delay: 0.6s; }
        .animate-delay-800 { animation-delay: 0.8s; }
        .card {
             background-color: #1A232C;
             border-radius: 0.75rem;
             padding: 2.5rem;
             color: #D1D5DB;
        }
        .btn {
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background-color: transparent;
        }
        .btn-primary {
            border-color: #38BDF8;
            color: #38BDF8;
        }
        .btn-primary:hover {
            background-color: #38BDF8;
            color: #0A0A0A;
        }
        .btn-secondary {
            border-color: #4B5563;
            color: #9CA3AF;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
            color: white;
        }
        
        .btn-user {
            border-color: #38BDF8;
            color: #38BDF8;
        }
        .btn-user:hover {
            background-color: #38BDF8;
            color: #0A0A0A;
        }

        .btn-family {
            border-color: #A78BFA;
            color: #A78BFA;
        }
        .btn-family:hover {
            background-color: #A78BFA;
            color: #0A0A0A;
        }

        .btn-results {
             border-color: #34D399;
            color: #34D399;
        }
        .btn-results:hover {
            background-color: #34D399;
            color: #0A0A0A;
        }


        .btn-primary:disabled, .btn-secondary:disabled, .btn-user:disabled, .btn-family:disabled, .btn-results:disabled {
            border-color: #4B5563;
            color: #6B7280;
            cursor: not-allowed;
            background-color: transparent;
        }

        .loader {
            border-color: #4B5563;
            border-top-color: #38BDF8;
        }
        .language-item:hover {
            background-color: #374151;
        }
        
        #blob {
            background: linear-gradient(to right, #A78BFA, #38BDF8);
            height: 34vmax;
            aspect-ratio: 1;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.3;
            z-index: -2;
            transition: transform 0.2s ease-out;
        }

        .scroll-section {
            opacity: 0;
            transform: translateY(-30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
        }

        .scroll-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        #home-screen-scroll-container {
             perspective: 1000px;
        }

        #visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            gap: 6px;
        }
        .visualizer-dot {
            width: 6px;
            height: 6px;
            background-color: #38BDF8;
            border-radius: 50%;
            transform: scaleY(0.4);
            transition: transform 0.1s ease-out;
        }
        .btn-icon {
            border: 2px solid #4B5563;
            color: #9CA3AF;
            border-radius: 9999px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-icon:hover {
            background-color: #4B5563;
            color: white;
            border-color: #4B5563;
        }
        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -1;
            opacity: 0.5;
            transition: opacity 0.5s ease-in-out;
        }
        
        body:not(.home-visible) #bg-video {
            opacity: 0;
        }


    </style>
</head>
<body class="bg-background-dark text-white home-visible">
    <video id="bg-video" muted playsinline loop></video>
    <div id="app" class="max-w-4xl w-full mx-auto p-4">
        
        <div id="blob"></div>
        
        <div id="home-screen">
            <div id="home-screen-scroll-container" class="relative w-full flex-col items-center justify-center -m-4">
                
                <section class="min-h-screen flex items-center justify-center relative z-10">
                    <div class="w-full max-w-3xl p-6 text-center">
                        <h1 class="text-6xl md:text-8xl font-extrabold tracking-tighter font-display opacity-0 animate-fade-in-down">
                            Project FN
                        </h1>
                        <p class="text-gray-300 text-lg md:text-xl font-normal leading-relaxed mt-6 max-w-2xl mx-auto opacity-0 animate-fade-in-up" style="animation-delay: 0.2s;">
                            Your personal guide to cognitive wellness. Understand your mind, track your progress, and unlock your full potential.
                        </p>
                    </div>
                </section>
                
                <section class="min-h-screen flex items-center justify-center scroll-section relative z-10" data-scroll-section>
                     <div class="w-full max-w-2xl mx-auto space-y-8 text-left">
                        <div class="flex items-start gap-4">
                            <div class="bg-accent-blue/10 p-2 rounded-full mt-1">
                                <span class="material-symbols-outlined text-accent-blue text-2xl">neurology</span>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-100">🧩 Cognitive Check-ups</h3>
                                <p class="text-gray-400 text-lg mt-2">Sharpen your mind with interactive, science-backed cognitive tests. Evaluate key areas such as memory, attention, problem-solving, and decision-making. Regular check-ups help you track your mental agility and notice improvements over time.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="min-h-screen flex items-center justify-center scroll-section relative z-10" data-scroll-section>
                     <div class="w-full max-w-2xl mx-auto space-y-8 text-left">
                        <div class="flex items-start gap-4">
                            <div class="bg-accent-green/10 p-2 rounded-full mt-1">
                                <span class="material-symbols-outlined text-accent-green text-2xl">insights</span>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-100">📊 Personalized Insights</h3>
                                <p class="text-gray-400 text-lg mt-2">Gain deeper understanding through detailed performance reports and visual trends. Discover your cognitive strengths, identify areas that need focus, and receive tailored recommendations to enhance your mental growth.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="min-h-screen flex items-center justify-center scroll-section relative z-10" data-scroll-section>
                    <div class="w-full max-w-2xl mx-auto space-y-8 text-left">
                        <div class="flex items-start gap-4">
                            <div class="bg-accent-purple/10 p-2 rounded-full mt-1">
                                <span class="material-symbols-outlined text-accent-purple text-2xl">self_improvement</span>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-100">🧘‍♂️ Mindful Exercises</h3>
                                <p class="text-gray-400 text-lg mt-2">Nurture your mind with calming and stimulating activities designed to improve focus, reduce stress, and boost overall brain health. Explore guided exercises that balance mindfulness and cognitive training for everyday clarity.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="min-h-screen flex flex-col items-center justify-center scroll-section relative z-10" data-scroll-section>
                    <div class="text-center">
                        <button id="start-app-btn" class="flex items-center justify-center rounded-full h-16 px-8 mx-auto bg-white text-background-dark text-lg font-bold leading-normal tracking-wide font-display hover:bg-gray-200 transition-colors duration-300 shadow-lg shadow-white/10">
                            <span class="truncate">Let's Start Your Check-up</span>
                            <span class="material-symbols-outlined ml-2">arrow_forward</span>
                        </button>
                    </div>
                     <footer class="absolute bottom-8 text-gray-600 text-sm">
                        Project FN © 2025
                    </footer>
                </section>

            </div>
        </div>

        <div id="dashboard-screen" class="hidden relative">
             <button id="back-to-home-btn" class="btn-icon absolute top-6 left-6 z-10">
                 <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div class="min-h-screen w-full flex flex-col items-center justify-center p-6 text-center">
                <div class="max-w-3xl w-full">
                    <div class="opacity-0 animate-fade-in-down">
                        <h1 class="text-4xl font-extrabold tracking-tight font-display">Choose Your Path</h1>
                        <p class="text-gray-400 text-lg mt-2">Select an assessment to begin your cognitive wellness journey.</p>
                    </div>

                    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button id="user-test-btn" data-test-type="user" class="border-2 border-card-dark p-6 rounded-xl text-left flex flex-col justify-between hover:border-accent-blue transition-colors duration-300">
                            <div>
                               <div class="bg-accent-blue/10 p-2 rounded-full w-min"><span class="material-symbols-outlined text-accent-blue text-3xl">psychology</span></div>
                                <h2 class="text-xl font-bold text-gray-100 mt-4">My Cognitive Check-up</h2>
                                <p class="text-gray-400 text-sm mt-1">Take the interactive test yourself to get a baseline of your cognitive functions.</p>
                            </div>
                        </button>
                        <button id="family-test-btn" data-test-type="family" class="border-2 border-card-dark p-6 rounded-xl text-left flex flex-col justify-between hover:border-accent-purple transition-colors duration-300">
                            <div>
                               <div class="bg-accent-purple/10 p-2 rounded-full w-min"><span class="material-symbols-outlined text-accent-purple text-3xl">visibility</span></div>
                                <h2 class="text-xl font-bold text-gray-100 mt-4">Observer's Insight</h2>
                                <p class="text-gray-400 text-sm mt-1">Have a friend or family member provide valuable observations about daily behaviors.</p>
                            </div>
                        </button>
                    </div>

                    <div class="mt-12">
                         <hr class="my-6 border-gray-800">
                         <button id="view-results-btn" class="btn btn-results h-12 px-6 w-full max-w-sm mx-auto flex items-center justify-center" disabled>
                            <span class="material-symbols-outlined mr-2">bar_chart</span>
                            View Combined Results
                         </button>
                         <p id="results-info" class="text-sm text-gray-500 mt-2">Complete at least one test to view results.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="language-selection" class="card hidden">
            <h1 class="text-3xl font-bold text-gray-100 mb-2">Select Language</h1>
            <p class="text-gray-300 mb-6">Search for your preferred language for the test.</p>
            <input type="search" id="language-search" placeholder="Search for a language..." class="w-full p-3 bg-gray-800 border-gray-600 rounded-lg focus:ring-2 focus:ring-accent-blue text-white mb-4">
            <div id="language-results" class="max-h-60 overflow-y-auto text-left"></div>
            <button id="back-to-dashboard-btn" class="btn btn-secondary w-full mt-4 h-12 px-6 flex items-center justify-center">Back</button>
        </div>

        <div id="instructions" class="card hidden">
            <h1 id="instructions-title" class="text-3xl font-bold text-gray-100 mb-4"></h1>
            <p id="instructions-p1" class="text-gray-300 mb-6"></p>
            <ul id="instructions-ul" class="text-left list-disc list-inside bg-gray-900/50 p-4 rounded-lg mb-6 space-y-2"></ul>
            <div class="space-y-4">
                <button id="start-btn" class="btn btn-primary w-full h-12 px-6 flex items-center justify-center"></button>
                <button id="start-audio-btn" class="btn btn-primary w-full h-12 px-6 flex items-center justify-center"></button>
                <button id="back-to-language-btn" class="btn btn-secondary w-full mt-2 h-12 px-6 flex items-center justify-center">Back</button>
            </div>
        </div>
        
        <div id="audio-questionnaire" class="card hidden text-center">
            <h2 class="text-2xl font-bold text-gray-100 mb-4"><span id="audio-question-title"></span> <span id="audio-question-number">1</span>/<span id="audio-total-questions">12</span></h2>
            <p id="audio-status" class="text-lg text-gray-400 mb-6"></p>
            <div id="visualizer" class="mb-6"></div>
            <p id="audio-question-text" class="text-xl font-semibold text-gray-100 h-12"></p>
            <button id="exit-audio-test-btn" class="btn btn-secondary w-full mt-4 h-12 px-6 flex items-center justify-center">Exit Test</button>
        </div>

        <div id="questionnaire" class="card hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-100"><span id="question-title"></span> <span id="question-number">1</span>/<span id="total-questions">12</span></h2>
                <div id="timer-container" class="text-lg font-semibold text-gray-300 hidden"><span id="timer-title"></span>: <span id="timer">30</span>s</div>
            </div>
            <div id="stimulus-container" class="mb-6 text-center hidden">
                <p id="stimulus-p1" class="text-gray-400 mb-2"></p>
                <div class="bg-accent-blue/10 p-4 rounded-lg">
                    <p id="stimulus-text" class="text-3xl font-bold text-accent-blue"></p>
                </div>
                <p class="text-gray-500 mt-2 text-sm" id="stimulus-p2"></p>
            </div>
            <div id="question-container" class="mb-6">
                 <div class="flex items-center justify-between">
                    <p id="question-text" class="text-lg text-gray-300 mb-4 flex-grow"></p>
                 </div>
                <textarea id="answer-input" class="w-full p-3 bg-gray-800 border-gray-600 rounded-lg focus:ring-2 focus:ring-accent-blue text-white" rows="4"></textarea>
                <div id="multiple-choice-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4"></div>
            </div>
            <button id="next-btn" class="btn btn-primary w-full h-12 px-6 flex items-center justify-center"></button>
            <button id="exit-text-test-btn" class="btn btn-secondary w-full mt-2 h-12 px-6 flex items-center justify-center">Exit Test</button>
        </div>

        <div id="loading" class="card text-center hidden">
             <h2 id="loading-title" class="text-2xl font-bold text-gray-100 mb-4"></h2>
             <p id="loading-p1" class="text-gray-300 mb-6"></p>
             <div class="loader mx-auto"></div>
        </div>

        <div id="results" class="card hidden relative">
            <button id="test-sheet-btn" class="absolute top-4 left-4 text-xs text-gray-500 hover:text-gray-300 transition-colors">Test Sheet</button>
            <h1 id="results-title" class="text-3xl font-bold text-gray-100 mb-4 text-center"></h1>
            <div class="text-center mb-6">
                 <p id="score-p1" class="text-lg text-gray-400"></p>
                 <p id="score-val" class="text-5xl font-bold text-accent-blue"></p>
            </div>
            <div class="mb-8">
                <h2 id="trend-title" class="text-xl font-semibold text-gray-200 mb-2 border-b border-gray-700 pb-2"></h2>
                <canvas id="trend-chart" height="150"></canvas>
            </div>
            <div id="feedback-container" class="space-y-6">
                <div>
                    <h2 id="status-title" class="text-xl font-semibold text-gray-200 mb-2 border-b border-gray-700 pb-2"></h2>
                    <p id="seriousness" class="text-gray-400"></p>
                </div>
                <div>
                    <h2 id="feedback-title" class="text-xl font-semibold text-gray-200 mb-2 border-b border-gray-700 pb-2"></h2>
                    <p id="feedback" class="text-gray-400"></p>
                </div>
                <div>
                    <h2 id="suggestions-title" class="text-xl font-semibold text-gray-200 mb-2 border-b border-gray-700 pb-2"></h2>
                    <div id="suggestions" class="text-gray-400 list-disc list-inside"></div>
                </div>
            </div>

            <div id="plan-generation-section" class="mt-8">
                 <button id="generate-plan-btn" class="btn btn-secondary w-full h-12 px-6 flex items-center justify-center">✨ Generate My 7-Day Cognitive Plan</button>
                 <p class="text-sm text-gray-500 mt-2">Click here to get a personalized, AI-generated plan with daily activities to support your cognitive health based on your test results.</p>
                 <div id="plan-loader" class="loader mx-auto my-4 hidden"></div>
            </div>
           
            <div id="plan-container" class="hidden mt-8">
                <h2 class="text-2xl font-bold text-gray-100 mb-4 text-center">Your 7-Day Cognitive Plan</h2>
                <div id="plan-content" class="space-y-4"></div>
            </div>

            <button id="restart-btn" class="btn btn-primary w-full mt-8 h-12 px-6 flex items-center justify-center"></button>
        </div>
    </div>
    
    <div id="test-sheet-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-dark rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-100">Test Sheet</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="test-sheet-content" class="space-y-4">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase & App Initialization ---
        let db, auth, userId;
        
        async function initFirebase() {
             try {
                const firebaseConfig = self.__firebase_config ? JSON.parse(self.__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Initialized. User ID:", userId);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }
        initFirebase();


        // --- DOM Elements & Global State ---
        const allScreens = document.querySelectorAll('#app > div:not(#blob)');
        const homeScreenEl = document.getElementById('home-screen');
        const dashboardScreenEl = document.getElementById('dashboard-screen');
        const languageSelectionEl = document.getElementById('language-selection');
        const instructionsEl = document.getElementById('instructions');
        const questionnaireEl = document.getElementById('questionnaire');
        const audioQuestionnaireEl = document.getElementById('audio-questionnaire');
        const loadingEl = document.getElementById('loading');
        const resultsEl = document.getElementById('results');
        const startAppBtn = document.getElementById('start-app-btn');
        const userTestBtn = document.getElementById('user-test-btn');
        const familyTestBtn = document.getElementById('family-test-btn');
        const viewResultsBtn = document.getElementById('view-results-btn');
        const startBtn = document.getElementById('start-btn');
        const startAudioBtn = document.getElementById('start-audio-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const languageSearchEl = document.getElementById('language-search');
        const languageResultsEl = document.getElementById('language-results');
        const visualizerEl = document.getElementById('visualizer');
        const exitTextTestBtn = document.getElementById('exit-text-test-btn');
        const exitAudioTestBtn = document.getElementById('exit-audio-test-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const backToLanguageBtn = document.getElementById('back-to-language-btn');
        const blob = document.getElementById("blob");
        const testSheetBtn = document.getElementById('test-sheet-btn');
        const testSheetModal = document.getElementById('test-sheet-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const testSheetContent = document.getElementById('test-sheet-content');
        const bgVideo = document.getElementById('bg-video');
        
        let currentTestType = 'user';
        let testState = { user: { completed: false, results: null }, family: { completed: false, results: null } };
        let currentQuestionIndex = 0;
        let userResults = [];
        let timerInterval;
        let currentDifficulty = 2;
        let askedQuestionIds = [];
        let totalScore = 0;
        let selectedLang = 'en-US';
        let mediaRecorder, audioChunks = [], audioContext, analyser, dataArray, source, silenceTimeout, recordingTimeout, currentAudioPlayer = null, isTestActive = false, isConfirming = false;
        
        // --- I18N & Questions Data ---
        const i18n = { 
            en: { 
                instructionsTitle: "Cognitive Assessment", 
                instructionsP1: "Please choose how you would like to take the test.", 
                instructionsLIs: [ "Text Mode: Read questions and type your answers.", "Audio Mode: Listen to questions and speak your answers.", "The difficulty will adapt based on your answers.", "The test consists of 12 questions for self-assessment." ],
                observerInstructionsTitle: "Observer Instructions",
                observerInstructionsP1: "Please answer the following questions about the person you are observing.",
                observerInstructionsLIs: ["Read questions about the person's daily behavior.", "Select the answer that best fits.", "This test helps provide context to the self-assessment."],
                startBtn: "Start Text Test", 
                startObserverBtn: "Start Observer Report",
                startAudioBtn: "Start Audio Test", 
                questionTitle: "Question", 
                timerTitle: "Time", 
                stimulusP1: "Remember the following for 10 seconds:", 
                stimulusP2: "You can answer after the timer ends.", 
                answerPlaceholder: "Go ahead, type your answer here!", 
                nextBtn: "Next Question", 
                submitBtn: "Submit", 
                loadingTitle: "Analyzing your results...", 
                loadingP1: "Our AI is processing your responses. This might take a moment.", 
                resultsTitle: "Your Cognitive Analysis", 
                scoreP1: "Your Score", 
                trendTitle: "Cognitive Trend", 
                statusTitle: "Cognitive Status", 
                feedbackTitle: "Detailed Feedback", 
                suggestionsTitle: "Suggestions for Cognitive Health", 
                restartBtn: "Back to Dashboard", 
                audioStatusListening: "Listening...",
                audioStatusConfirm: "Did I hear that right? Say 'yes' to confirm or 'no' to try again.",
                audioStatusSpeaking: "Speaking...", 
                audioStatusProcessing: "Processing...", 
            }, 
            te: { 
                instructionsTitle: "అభిజ్ఞా మూల్యాంకనం", 
                instructionsP1: "దయచేసి మీరు పరీక్షను ఎలా రాయాలనుకుంటున్నారో ఎంచుకోండి.", 
                instructionsLIs: [ "టెక్స్ట్ మోడ్: ప్రశ్నలను చదివి మీ సమాధానాలను టైప్ చేయండి.", "ఆడియో మోడ్: ప్రశ్నలను విని మీ సమాధానాలను మాట్లాడండి.", "మీ సమాధానాల ఆధారంగా కష్టత సర్దుబాటు చేయబడుతుంది.", "స్వీయ-అంచనా కోసం పరీక్షలో 12 ప్రశ్నలు ఉంటాయి." ],
                observerInstructionsTitle: "పరిశీలకుల సూచనలు",
                observerInstructionsP1: "దయచేసి మీరు గమనిస్తున్న వ్యక్తి గురించి క్రింది ప్రశ్నలకు సమాధానం ఇవ్వండి.",
                observerInstructionsLIs: ["వ్యక్తి యొక్క రోజువారీ ప్రవర్తన గురించి ప్రశ్నలను చదవండి.", "అత్యంత సరిపోయే సమాధానాన్ని ఎంచుకోండి.", "ఈ పరీక్ష స్వీయ-అంచనాకు సందర్భాన్ని అందించడంలో సహాయపడుతుంది."],
                startBtn: "టెక్స్ట్ పరీక్ష ప్రారంభించండి", 
                startObserverBtn: "పరిశీలకుల నివేదికను ప్రారంభించండి",
                startAudioBtn: "ఆడియో పరీక్ష ప్రారంభించండి", 
                questionTitle: "ప్రశ్న", 
                timerTitle: "సమయం", 
                stimulusP1: "కింది వాటిని 10 సెకన్ల పాటు గుర్తుంచుకోండి:", 
                stimulusP2: "టైమర్ ముగిసిన తర్వాత మీరు సమాధానం ఇవ్వవచ్చు.", 
                answerPlaceholder: "మీ సమాధానం ఇక్కడ టైప్ చేయండి!", 
                nextBtn: "తదుపరి ప్రశ్న", 
                submitBtn: "సమర్పించు", 
                loadingTitle: "మీ ఫలితాలను విశ్లేషిస్తోంది...", 
                loadingP1: "మా AI మీ స్పందనలను ప్రాసెస్ చేస్తోంది. దీనికి కొంత సమయం పట్టవచ్చు.", 
                resultsTitle: "మీ అభిజ్ఞా విశ్లేషణ", 
                scoreP1: "మీ స్కోర్", 
                trendTitle: "అభిజ్ఞా ధోరణి", 
                statusTitle: "అభిజ్ఞా స్థితి", 
                feedbackTitle: "వివరణాత్మక అభిప్రాయం", 
                suggestionsTitle: "అభిజ్ఞా ఆరోగ్యం కోసం సూచనలు", 
                restartBtn: "డాష్‌బోర్డ్‌కి తిరిగి వెళ్ళు", 
                audioStatusListening: "వింటున్నాను...", 
                audioStatusConfirm: "నేను విన్నది సరైనదేనా? 'అవును' అని చెప్పండి లేదా మళ్ళీ ప్రయత్నించడానికి 'కాదు' అని చెప్పండి.",
                audioStatusSpeaking: "మాట్లాడుతున్నాను...", 
                audioStatusProcessing: "ప్రాసెస్ చేస్తున్నాను...", 
            },
            hi: {
                instructionsTitle: "संज्ञानात्मक मूल्यांकन",
                instructionsP1: "कृपया चुनें कि आप परीक्षण कैसे देना चाहेंगे।",
                instructionsLIs: [
                    "टेक्स्ट मोड: प्रश्न पढ़ें और अपने उत्तर टाइप करें।",
                    "ऑडियो मोड: प्रश्न सुनें और अपने उत्तर बोलें।",
                    "आपके उत्तरों के आधार पर कठिनाई अनुकूलित होगी।",
                    "आत्म-मूल्यांकन के लिए परीक्षण में 12 प्रश्न हैं।"
                ],
                observerInstructionsTitle: "पर्यवेक्षक निर्देश",
                observerInstructionsP1: "कृपया उस व्यक्ति के बारे में निम्नलिखित प्रश्नों के उत्तर दें जिनका आप अवलोकन कर रहे हैं।",
                observerInstructionsLIs: [
                    "व्यक्ति के दैनिक व्यवहार के बारे में प्रश्न पढ़ें।",
                    "सबसे उपयुक्त उत्तर चुनें।",
                    "यह परीक्षण आत्म-मूल्यांकन को संदर्भ प्रदान करने में मदद करता है।"
                ],
                startBtn: "टेक्स्ट टेस्ट शुरू करें",
                startObserverBtn: "पर्यवेक्षक रिपोर्ट शुरू करें",
                startAudioBtn: "ऑडियो टेस्ट शुरू करें",
                questionTitle: "प्रश्न",
                timerTitle: "समय",
                stimulusP1: "इसे 10 सेकंड के लिए याद रखें:",
                stimulusP2: "टाइमर समाप्त होने के बाद आप उत्तर दे सकते हैं।",
                answerPlaceholder: "अपना जवाब यहाँ टाइप करें!",
                nextBtn: "अगला प्रश्न",
                submitBtn: "प्रस्तुत करें",
                loadingTitle: "आपके परिणामों का विश्लेषण किया जा रहा है...",
                loadingP1: "हमारा AI आपकी प्रतिक्रियाओं को संसाधित कर रहा है। इसमें कुछ समय लग सकता है।",
                resultsTitle: "आपका संज्ञानात्मक विश्लेषण",
                scoreP1: "आपका स्कोर",
                trendTitle: "संज्ञानात्मक प्रवृत्ति",
                statusTitle: "संज्ञानात्मक स्थिति",
                feedbackTitle: "विस्तृत प्रतिक्रिया",
                suggestionsTitle: "संज्ञानात्मक स्वास्थ्य के लिए सुझाव",
                restartBtn: "डैशबोर्ड पर वापस जाएं",
                audioStatusListening: "सुन रहा है...",
                audioStatusConfirm: "क्या मैंने सही सुना? पुष्टि करने के लिए 'हाँ' कहें या फिर से प्रयास करने के लिए 'नहीं' कहें।",
                audioStatusSpeaking: "बोल रहा है...",
                audioStatusProcessing: "संसाधित हो रहा है..."
            }
        };
        const supportedLanguages = [ 
            { code: 'te-IN', name: 'తెలుగు (Telugu)' }, 
            { code: 'hi-IN', name: 'हिन्दी (Hindi)' }, 
            { code: 'en-US', name: 'English (US)' }
        ];
        
        const userQuestions = [
            { id: 1, domain: 'Orientation', type: 'recall', difficulty: 1, en: { question: "What season is it right now?" }, te: { question: "బయట ఏ కాలం నడుస్తోందో చెప్పగలరా?" }, hi: { question: "अभी कौन सा मौसम चल रहा है?" }, correctAnswer: "Monsoon" },
            { id: 2, domain: 'Language', type: 'recall', difficulty: 1, en: { question: "Go ahead and name three things you see in the room!" }, te: { question: "ఈ గదిలో మీకు కనిపిస్తున్న ఓ మూడు వస్తువుల పేర్లు చెప్పండి!" }, hi: { question: "इस कमरे में आपको जो तीन चीजें दिख रही हैं, उनके नाम बताइए!" }, correctAnswer: "User specific" },
            { id: 3, domain: 'Registration', type: 'timed-stimulus', difficulty: 1, en: { stimulus: "Here's a number to remember: 835291", question: "Alright, what was that 6-digit number I just showed you?" }, te: { stimulus: "ఈ నంబర్‌ను గుర్తుంచుకోండి: 835291", question: "సరే, ఇందాక మీకు చూపించిన 6 అంకెల నంబర్ ఏంటో చెప్పండి?" }, hi: { stimulus: "यह नंबर याद रखें: 835291", question: "ठीक है, वह 6 अंकों वाला नंबर क्या था जो मैंने आपको अभी दिखाया था?" }, correctAnswer: "835291" },
            { id: 4, domain: 'Orientation', type: 'recall', difficulty: 2, en: { question: "What's today's date?" }, te: { question: "ఈ రోజు తేదీ ఎంతో చెప్పండి?" }, hi: { question: "आज क्या तारीख है?" }, correctAnswer: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) },
            { id: 5, domain: 'Attention', type: 'recall', difficulty: 2, en: { question: "Can you try spelling the word 'WORLD' backwards?" }, te: { question: "‘రాముడు’ అనే పదాన్ని వెనకనుంచి ఒకసారి చెప్పి చూడండి." }, hi: { question: "'दुनिया' शब्द को उल्टा स्पेल करके बताइए।" }, correctAnswer: "DLROW" },
            { id: 6, domain: 'Registration', type: 'timed-stimulus', difficulty: 2, en: { stimulus: "Remember these three things: Ball, Flag, Tree", question: "Okay, what were those three things I just mentioned?" }, te: { stimulus: "ఈ మూడు వస్తువులను గుర్తుంచుకోండి: బంతి, జెండా, చెట్టు", question: "సరే, నేను చెప్పిన ఆ మూడు వస్తువులు ఏంటో చెప్పండి." }, hi: { stimulus: "ये तीन चीजें याद रखें: गेंद, झंडा, पेड़", question: "ठीक है, वे तीन चीजें क्या थीं जिनका मैंने अभी जिक्र किया?" }, correctAnswer: "Ball, Flag, Tree" },
            { id: 7, domain: 'Recall', type: 'recall', difficulty: 2, en: { question: "Let's jog your memory! What were those three things you saw in the room a little while ago?" }, te: { question: "మీ జ్ఞాపకశక్తిని పరీక్షిద్దాం! ఇంతకుముందు మీరు గదిలో చూసిన ఆ మూడు వస్తువులు ఏంటో చెప్పండి?" }, hi: { question: "चलिए आपकी याददाश्त की जांच करते हैं! थोड़ी देर पहले आपने कमरे में कौन सी तीन चीजें देखी थीं?" }, correctAnswer: "User specific" },
            { id: 8, domain: 'Attention', type: 'recall', difficulty: 3, en: { question: "Let's try some math! Can you start at 100 and count down by 7, five times?" }, te: { question: "ఒక చిన్న లెక్క చేద్దాం! 100 నుంచి 7 తీసివేస్తూ, అలా ఐదుసార్లు చెప్పగలరా?" }, hi: { question: "चलो कुछ गणित करते हैं! क्या आप 100 से शुरू करके 7 घटाते हुए, पांच बार गिनती कर सकते हैं?" }, correctAnswer: "93, 86, 79, 72, 65" },
            { id: 9, domain: 'Problem-Solving', type: 'recall', difficulty: 3, en: { question: "A small calculation. A bat and a ball together cost 20. The bat costs 8 more than the ball. What is the price of the ball?" }, te: { question: "ఒక చిన్న లెక్క. ఒక బ్యాట్, బంతి కలిపి 20. బంతి కన్నా బ్యాట్ 8 ఎక్కువ. అయితే బంతి ధర ఎంత?" }, hi: { question: "एक छोटा सा हिसाब। एक बैट और एक बॉल की कुल कीमत 20 है। बैट की कीमत बॉल से 8 ज़्यादा है। तो बॉल की कीमत क्या है?" }, correctAnswer: "6" },
            { id: 10, domain: 'Language', type: 'recall', difficulty: 3, en: { question: "Name one thing that both a chair and a bed are used for." }, te: { question: "కుర్చీ మరియు మంచం రెండింటి ఉపయోగం ఏది?" }, hi: { question: "एक ऐसी चीज़ का नाम बताइए जो कुर्सी और बिस्तर दोनों के काम आती है।" }, correctAnswer: "Sitting" },
            { id: 11, domain: 'Language', type: 'recall', difficulty: 1, en: { question: "Name as many fruits as you can in 30 seconds." }, te: { question: "మీరు 30 సెకన్లలో గుర్తు చేసుకోగలన్ని పండ్లు చెప్పండి." }, hi: { question: "30 सेकंड में जितने फलों के नाम याद कर सकते हैं, बताइए।" }, correctAnswer: "User specific" },
            { id: 12, domain: 'Language', type: 'recall', difficulty: 2, en: { question: "Pick up the pen, place it on the book, then say the window is near. What did you do first?" }, te: { question: "పెన్ తీసుకుని, పుస్తకంపై పెట్టండి, తర్వాత కిటికీ దగ్గర ఉందని చెప్పండి. మీరు మొదట ఏమి చేసారు?" }, hi: { question: "पेन उठाइए, इसे किताब पर रखिए, फिर खिड़की पास है कहिए। आपने सबसे पहले क्या किया?" }, correctAnswer: "Pick up the pen" }
        ];

        const observerQuestions = [
            { id: 101, en: { question: "How often would you say they forget recent chats or things that just happened?" }, te: { question: "ఇటీవల జరిగిన సంభాషణలు లేదా విషయాలు ఆ వ్యక్తి ఎంత తరచుగా మర్చిపోతున్నారని మీరు గమనించారు?" }, hi: { question: "वे हाल की बातचीत या अभी हुई बातें कितनी बार भूल जाते हैं?" }, choices: [ { text: { en: 'Never', te: 'అస్సలు లేదు', hi: 'कभी नहीं' }, score: 0 }, { text: { en: 'Rarely', te: 'అప్పుడప్పుడు', hi: 'कभी-కभार' }, score: 1 }, { text: { en: 'Sometimes', te: 'కొన్నిసార్లు', hi: 'कभी-कभी' }, score: 2 }, { text: { en: 'Often', te: 'తరచుగా', hi: 'अक्सर' }, score: 3 } ] },
            { id: 102, en: { question: "What about everyday things? Do they often forget where they put their keys or phone?" }, te: { question: "ఆ వ్యక్తి తాళాలు, ఫోన్ లాంటివి తరచుగా ఎక్కడ పెట్టారో మర్చిపోతుంటారా?" }, hi: { question: "रोजमर्रा की चीजों के बारे में क्या? क्या वे अक्सर अपनी चाबियां या फोन रखकर भूल जाते हैं?" }, choices: [ { text: { en: 'Never', te: 'అస్సలు లేదు', hi: 'कभी नहीं' }, score: 0 }, { text: { en: 'Rarely', te: 'అప్పుడప్పుడు', hi: 'कभी-కभार' }, score: 1 }, { text: { en: 'Sometimes', te: 'కొన్నిసార్లు', hi: 'कभी-कभी' }, score: 2 }, { text: { en: 'Often', te: 'తరచుగా', hi: 'अक्सर' }, score: 3 } ] },
            { id: 103, en: { question: "Do you ever notice them asking the same question again, or telling the same story soon after they just told it?" }, te: { question: "ఒకే ప్రశ్నను మళ్లీ మళ్లీ అడగటం లేదా ఒకే కథను కొద్దిసేపటికే మళ్లీ చెప్పడం మీరు గమనించారా?" }, hi: { question: "क्या आप कभी देखते हैं कि वे एक ही सवाल दोबारा पूछते हैं, या एक ही कहानी सुनाने के तुरंत बाद फिर से सुनाते हैं?" }, choices: [ { text: { en: 'Never', te: 'అస్సలు లేదు', hi: 'कभी नहीं' }, score: 0 }, { text: { en: 'Rarely', te: 'అప్పుడప్పుడు', hi: 'कभी-కभार' }, score: 1 }, { text: { en: 'Sometimes', te: 'కొన్నిసార్లు', hi: 'कभी-कभी' }, score: 2 }, { text: { en: 'Often', te: 'తరచుగా', hi: 'अक्सर' }, score: 3 } ] },
            { id: 104, en: { question: "Are they forgetting how to do things they used to do easily, or having trouble doing them now?" }, te: { question: "వారు ఇంతకుముందు సులభంగా చేసేవి ఇప్పుడు ఎలా చేయాలో మరిచిపోతున్నారా లేదా చేయడంలో ఇబ్బంది పడుతున్నారా?" }, hi: { question: "क्या वे उन कामों को करना भूल रहे हैं जो वे पहले आसानी से कर लेते थे, या अब उन्हें करने में परेशानी हो रही है?" }, choices: [ { text: { en: 'Never', te: 'అస్సలు లేదు', hi: 'कभी नहीं' }, score: 0 }, { text: { en: 'Rarely', te: 'అప్పుడప్పుడు', hi: 'कभी-కभार' }, score: 1 }, { text: { en: 'Sometimes', te: 'కొన్నిసార్లు', hi: 'कभी-कभी' }, score: 2 }, { text: { en: 'Often', te: 'తరచుగా', hi: 'अक्सर' }, score: 3 } ] },
            { id: 105, en: { question: "When you're talking, do they ever seem to struggle to find the right word?" }, te: { question: "మాట్లాడుతున్నప్పుడు, సరైన పదం కోసం వెతుక్కోవడం మీరు గమనించారా?" }, hi: { question: "बात करते समय, क्या वे अक्सर सही शब्द खोजने में अटकते हैं?" }, choices: [ { text: { en: 'Never', te: 'అస్సలు లేదు', hi: 'कभी नहीं' }, score: 0 }, { text: { en: 'Rarely', te: 'అప్పుడప్పుడు', hi: 'कभी-కभार' }, score: 1 }, { text: { en: 'Sometimes', te: 'కొన్నిసార్లు', hi: 'कभी-कभी' }, score: 2 }, { text: { en: 'Often', te: 'తరచుగా', hi: 'अक्सर' }, score: 3 } ] }
        ];
        
        // --- Event Listeners ---
        window.addEventListener('pointermove', (event) => {
            const { clientX, clientY } = event;
            blob.style.transform = `translate(${clientX - (window.innerWidth / 2)}px, ${clientY - (window.innerHeight / 2)}px)`;
        });

        startAppBtn.addEventListener('click', () => { 
            updateDashboard(); 
            homeScreenEl.classList.add('hidden');
            dashboardScreenEl.classList.remove('hidden');
        });
        viewResultsBtn.addEventListener('click', generateAndShowResults);
        generatePlanBtn.addEventListener('click', generateCognitivePlan);
        
        [userTestBtn, familyTestBtn].forEach(btn => btn.addEventListener('click', (e) => {
            currentTestType = e.currentTarget.dataset.testType;
            languageSearchEl.value = '';
            handleLanguageSearch(); // Call to populate the list
            showScreen(languageSelectionEl);
        }));

        languageSearchEl.addEventListener('input', handleLanguageSearch);
        startBtn.addEventListener('click', startTest);
        startAudioBtn.addEventListener('click', startAudioTest);
        nextBtn.addEventListener('click', processNextQuestion);
        restartBtn.addEventListener('click', () => { updateDashboard(); showScreen(dashboardScreenEl); });
        [exitTextTestBtn, exitAudioTestBtn].forEach(btn => btn.addEventListener('click', exitTest));

        backToHomeBtn.addEventListener('click', () => {
            showScreen(homeScreenEl);
        });
        backToDashboardBtn.addEventListener('click', () => showScreen(dashboardScreenEl));
        backToLanguageBtn.addEventListener('click', () => showScreen(languageSelectionEl));
        testSheetBtn.addEventListener('click', () => {
            testSheetModal.classList.remove('hidden');
            testSheetModal.classList.add('flex');
        });
        closeModalBtn.addEventListener('click', () => {
            testSheetModal.classList.add('hidden');
            testSheetModal.classList.remove('flex');
        });
        testSheetModal.addEventListener('click', (e) => {
            if (e.target === testSheetModal) {
                testSheetModal.classList.add('hidden');
                testSheetModal.classList.remove('flex');
            }
        });

        // --- Core Functions ---
        function showScreen(screen) { 
            document.body.classList.toggle('home-visible', screen === homeScreenEl);
            document.querySelectorAll('#app > div:not(#blob)').forEach(el => el.classList.add('hidden'));
            screen.classList.remove('hidden'); 
        }
        
        function exitTest() { 
            isTestActive = false;
            stopRecording(false); 
            speechSynthesis.cancel();
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            updateDashboard(); 
            showScreen(dashboardScreenEl); 
        }

        function handleLanguageSearch(e) {
            const query = (e && e.target) ? e.target.value.toLowerCase() : '';
            languageResultsEl.innerHTML = '';
            const filtered = supportedLanguages.filter(lang => lang.name.toLowerCase().includes(query));
            
            if (filtered.length === 0) {
                languageResultsEl.innerHTML = `<div class="p-4 text-gray-500 text-center">No languages found.</div>`;
            } else {
                filtered.forEach(lang => {
                    const item = document.createElement('div');
                    item.className = 'language-item';
                    item.textContent = lang.name;
                    item.dataset.langCode = lang.code;
                    item.onclick = () => setLanguage(lang.code);
                    languageResultsEl.appendChild(item);
                });
            }
        }

        function updateDashboard() {
            const userBtn = document.getElementById('user-test-btn');
            const familyBtn = document.getElementById('family-test-btn');

            userBtn.disabled = testState.user.completed;
            familyBtn.disabled = testState.family.completed;

            if (testState.user.completed) {
                userBtn.classList.add('opacity-50', 'cursor-not-allowed');
                userBtn.querySelector('h2').textContent = 'My Cognitive Check-up (Completed)';
            }
             if (testState.family.completed) {
                familyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                familyBtn.querySelector('h2').textContent = "Observer's Insight (Completed)";
            }

            const oneCompleted = testState.user.completed || testState.family.completed;
            viewResultsBtn.disabled = !oneCompleted;
            document.getElementById('results-info').style.display = oneCompleted ? 'none' : 'block';
        }

        function setLanguage(langCode) {
            selectedLang = langCode;
            const langPrefix = langCode.split('-')[0];
            const t = i18n[langPrefix] || i18n.en;

            if (currentTestType === 'family') {
                document.getElementById('instructions-title').textContent = t.observerInstructionsTitle;
                document.getElementById('instructions-p1').textContent = t.observerInstructionsP1;
                document.getElementById('instructions-ul').innerHTML = t.observerInstructionsLIs.map(item => `<li>${item}</li>`).join('');
                startBtn.textContent = t.startObserverBtn;
                startAudioBtn.classList.add('hidden');
            } else {
                document.getElementById('instructions-title').textContent = t.instructionsTitle;
                document.getElementById('instructions-p1').textContent = t.instructionsP1;
                document.getElementById('instructions-ul').innerHTML = t.instructionsLIs.map(item => `<li>${item}</li>`).join('');
                startBtn.textContent = t.startBtn;
                startAudioBtn.textContent = t.startAudioBtn;
                startAudioBtn.classList.remove('hidden');
            }
            showScreen(instructionsEl);
        }

        function resetTestState() { 
            currentQuestionIndex = 0; 
            userResults = []; 
            totalScore = 0; 
            askedQuestionIds = []; 
            currentDifficulty = 2; 
        }

        function startTest() {
            isTestActive = true;
            resetTestState();
            const langPrefix = selectedLang.split('-')[0];
            const t = i18n[langPrefix] || i18n.en;
            document.getElementById('question-title').textContent = t.questionTitle;
            document.getElementById('next-btn').textContent = t.nextBtn;

            if (currentTestType === 'user') {
                document.getElementById('total-questions').textContent = userQuestions.length;
                document.getElementById('answer-input').style.display = 'block';
                document.getElementById('multiple-choice-container').style.display = 'none';
            } else {
                document.getElementById('total-questions').textContent = observerQuestions.length;
                document.getElementById('timer-container').style.display = 'none';
                document.getElementById('answer-input').style.display = 'none';
                document.getElementById('multiple-choice-container').style.display = 'grid';
            }
            showScreen(questionnaireEl);
            displayQuestion();
        }
        
        function displayQuestion() {
            if (!isTestActive) return;
            const isUserTest = currentTestType === 'user';
            const questions = isUserTest ? userQuestions : observerQuestions;
            if (currentQuestionIndex >= questions.length) { endTest(false); return; }
            
            const langPrefix = selectedLang.split('-')[0];
            const t = i18n[langPrefix] || i18n.en;
            if(currentQuestionIndex === questions.length - 1) {
                nextBtn.textContent = t.submitBtn;
            } else {
                nextBtn.textContent = t.nextBtn;
            }

            let question = isUserTest ? (questions.filter(q => !askedQuestionIds.includes(q.id) && q.difficulty === currentDifficulty)[0] || questions.filter(q => !askedQuestionIds.includes(q.id))[0]) : questions[currentQuestionIndex];
            if (!question) { endTest(false); return; }

            askedQuestionIds.push(question.id);
            document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            const questionText = question[langPrefix]?.question || question.en.question;
            document.getElementById('question-text').textContent = questionText;
            
            if (isUserTest && question.id === 11) {
                document.getElementById('timer-container').classList.remove('hidden');
                startTimer(30);
            } else {
                document.getElementById('timer-container').classList.add('hidden');
                clearInterval(timerInterval);
            }


            if (isUserTest) {
                if (question.type === 'timed-stimulus') {
                    document.getElementById('stimulus-text').textContent = question[langPrefix]?.stimulus || question.en.stimulus;
                    document.getElementById('stimulus-container').classList.remove('hidden');
                    document.getElementById('question-container').classList.add('hidden');
                    nextBtn.classList.add('hidden');
                    setTimeout(() => { 
                        if (!isTestActive) return;
                        showRecallQuestion(question); 
                        nextBtn.classList.remove('hidden'); 
                    }, 10000);
                } else {
                    showRecallQuestion(question);
                }
            } else { // Observer Test
                const mcContainer = document.getElementById('multiple-choice-container');
                mcContainer.innerHTML = '';
                nextBtn.classList.add('hidden');
                question.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-secondary text-left h-12 px-6 flex items-center justify-center';
                    button.textContent = choice.text[langPrefix] || choice.text.en;
                    button.onclick = () => processObserverAnswer(choice, question);
                    mcContainer.appendChild(button);
                });
            }
        }
        
        function showRecallQuestion(question) {
            document.getElementById('stimulus-container').classList.add('hidden');
            document.getElementById('question-container').classList.remove('hidden');
            const langPrefix = selectedLang.split('-')[0];
            document.getElementById('question-text').textContent = question[langPrefix]?.question || question.en.question;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
        }
        
        function processNextQuestion() {
            clearInterval(timerInterval);
            if (currentTestType !== 'user') return;
            const answer = document.getElementById('answer-input').value.trim();
            const question = userQuestions.find(q => q.id === askedQuestionIds[askedQuestionIds.length - 1]);
            const isCorrect = answer.toLowerCase() === String(question.correctAnswer).toLowerCase();
            if (isCorrect) { totalScore += question.difficulty; currentDifficulty = Math.min(3, currentDifficulty + 1); } 
            else { currentDifficulty = Math.max(1, currentDifficulty - 1); }
            userResults.push({ question: question.en.question, userAnswer: answer, isCorrect, difficulty: question.difficulty });
            currentQuestionIndex++;
            displayQuestion();
        }

        function processObserverAnswer(choice, question) {
            totalScore += choice.score;
            const langPrefix = selectedLang.split('-')[0];
            userResults.push({
                question: question.en.question,
                observerAnswer: choice.text.en,
                score: choice.score
            });
            currentQuestionIndex++;
            displayQuestion();
        }

         function startTimer(duration) {
            let timeLeft = duration;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isTestActive) { clearInterval(timerInterval); return; }
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    processNextQuestion(); // Automatically submit
                }
            }, 1000);
        }

        // --- Audio Test Functions ---
        async function startAudioTest() { 
            isTestActive = true;
            resetTestState();
            if (currentTestType !== 'user') {
                alert("Audio test is only available for 'My Cognitive Check-up'.");
                return;
            }
            document.getElementById('audio-total-questions').textContent = userQuestions.length;
            showScreen(audioQuestionnaireEl);
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupAudioProcessing(stream);
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = askForConfirmation;
                displayAudioQuestion();
            } catch(err) { console.error("Mic error:", err); }
        }

        function displayAudioQuestion() {
            if (!isTestActive) return;
            if (currentQuestionIndex >= userQuestions.filter(q=>q.type !== 'timed-stimulus').length) { endTest(true); return; }
            let question = userQuestions.filter(q => !askedQuestionIds.includes(q.id) && q.difficulty === currentDifficulty && q.type !== 'timed-stimulus')[0] || 
                           userQuestions.filter(q => !askedQuestionIds.includes(q.id) && q.type !== 'timed-stimulus')[0];
            if (!question) { endTest(true); return; }
            
            askedQuestionIds.push(question.id);
            document.getElementById('audio-question-number').textContent = currentQuestionIndex + 1;
            const langPrefix = selectedLang.split('-')[0];
            const questionText = question[langPrefix]?.question || question.en.question;
            document.getElementById('audio-question-text').textContent = questionText;
            
            speak(questionText, true, () => {
                if (isTestActive) startRecording();
            });
        }
        
        function speak(text, isQuestion, onEndCallback) {
            const langPrefix = selectedLang.split('-')[0];
            const t = i18n[langPrefix] || i18n.en;
            document.getElementById('audio-status').textContent = t.audioStatusSpeaking;
            visualize(true);

            speakWithGeminiTTS(text, selectedLang).then(() => {
                if (isQuestion) {
                     document.getElementById('audio-status').textContent = t.audioStatusListening;
                }
                visualize(false);
                if(onEndCallback) onEndCallback();
            }).catch(err => {
                 console.warn("Gemini TTS failed, falling back to browser TTS.", err);
                 const utterance = new SpeechSynthesisUtterance(text);
                 utterance.lang = selectedLang;
                 utterance.onend = () => {
                     if (isQuestion) {
                        document.getElementById('audio-status').textContent = t.audioStatusListening;
                     }
                     visualize(false);
                     if(onEndCallback) onEndCallback();
                 };
                 speechSynthesis.speak(utterance);
            });
        }
        
        async function processUnanswered() {
             if (!isTestActive) return;
            console.log("30 second timeout reached. No answer recorded.");
            stopRecording(false); // Stop without asking for confirmation
            userResults.push({ 
                question: userQuestions.find(q => q.id === askedQuestionIds[askedQuestionIds.length-1]).en.question,
                userAnswer: "Not Answered", 
                isCorrect: false, 
                difficulty: currentDifficulty 
            });
            currentQuestionIndex++;
            setTimeout(() => { if (isTestActive) displayAudioQuestion(); }, 1000);
        }

        async function askForConfirmation() {
            if (!isTestActive || isConfirming) return;
            isConfirming = true;
            const langPrefix = selectedLang.split('-')[0];
            const t = i18n[langPrefix] || i18n.en;
            document.getElementById('audio-status').textContent = t.audioStatusConfirm;
            speak(t.audioStatusConfirm, false, () => {
                 // Simulate listening for confirmation (e.g., 'yes' or 'no')
                 // In this version, we'll just assume 'yes' after a short delay
                 setTimeout(() => {
                     if (!isTestActive) return;
                     console.log("Simulating 'yes' confirmation.");
                     processAudioAnswer();
                     isConfirming = false;
                 }, 3000); // Wait 3 seconds to simulate listening for confirmation
            });
        }
        
        async function processAudioAnswer() {
            if (!isTestActive) return;
            const question = userQuestions.find(q => q.id === askedQuestionIds[askedQuestionIds.length - 1]);
            const isCorrect = true; // Simplified for audio simulation
            if (isCorrect) { totalScore += question.difficulty; currentDifficulty = Math.min(3, currentDifficulty + 1); } 
            else { currentDifficulty = Math.max(1, currentDifficulty - 1); }
            userResults.push({ question: question.en.question, transcribedAnswer: "[Simulated]", isCorrect, difficulty: question.difficulty });
            currentQuestionIndex++;
            setTimeout(() => { if (isTestActive) displayAudioQuestion(); }, 1000);
        }
        
        // --- Results & AI Functions ---
        function endTest(isAudioTest) {
            isTestActive = false;
            stopRecording(false);
            speechSynthesis.cancel();
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            testState[currentTestType].completed = true;
            testState[currentTestType].results = { score: totalScore, data: userResults, isAudio: isAudioTest };
            saveTestResult(totalScore, currentTestType);
            updateDashboard();
            showScreen(dashboardScreenEl);
        }
        
        async function generateAndShowResults() {
            showScreen(loadingEl);
            const prompt = `Analyze JSON data from a cognitive assessment with two parts: a self-assessment ('user') and an observer's report ('family'). One or both parts may be completed. The user test is a cognitive test with a score. The family test score is a concern level based on observed behaviors (higher score = more concern). Analyze score(s), look for discrepancies. Provide a combined analysis. Return JSON with keys "seriousness", "feedback", "suggestions". Suggestions MUST be an array of strings. JSON: ${JSON.stringify(testState, null, 2)}`;
            try {
                const result = await callGeminiAPI(prompt);
                displayResults(result);
            } catch (error) { console.error("Error analyzing results:", error); }
        }
        
        async function generateCognitivePlan() {
            const planLoader = document.getElementById('plan-loader');
            const planBtn = document.getElementById('generate-plan-btn');
            planLoader.classList.remove('hidden');
            planBtn.classList.add('hidden');

            const prompt = `You are a compassionate cognitive health expert. A user has completed a cognitive assessment. Their results are in the following JSON. Based on their performance, create a detailed, personalized 7-day cognitive health plan. The plan should be easy to follow and focus on areas related to their assessment. Include daily activities covering memory, attention, problem-solving, and lifestyle suggestions (diet, exercise, sleep). Format the response as a valid JSON object with a single key "plan", which is an array of 7 objects. Each object must have keys: "day" (e.g., "Day 1"), "focus_area" (string), "activities" (an array of strings), and "lifestyle_tip" (string). JSON data: ${JSON.stringify(testState, null, 2)}`;
            
            try {
                const result = await callGeminiAPI(prompt);
                displayCognitivePlan(result.plan);
            } catch(error) {
                console.error("Error generating plan:", error);
                document.getElementById('plan-container').innerHTML = `<p class="text-red-500 text-center">Sorry, couldn't generate a plan at this time.</p>`;
            } finally {
                planLoader.classList.add('hidden');
                 document.getElementById('plan-container').classList.remove('hidden');
            }
        }

        function displayCognitivePlan(plan) {
            const planContent = document.getElementById('plan-content');
            planContent.innerHTML = '';
            if (!plan || !Array.isArray(plan)) {
                planContent.textContent = 'Could not generate a valid plan.';
                return;
            }

            plan.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'p-4 border border-gray-700 rounded-lg bg-gray-900/50';
                
                let activitiesHtml = day.activities.map(activity => `<li>${activity}</li>`).join('');

                dayCard.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-200">${day.day}: ${day.focus_area}</h3>
                    <p class="font-semibold mt-2 text-gray-300">Activities:</p>
                    <ul class="list-disc list-inside ml-4 text-gray-400">${activitiesHtml}</ul>
                    <p class="mt-2 text-gray-400"><span class="font-semibold text-gray-300">Tip:</span> ${day.lifestyle_tip}</p>
                `;
                planContent.appendChild(dayCard);
            });
        }

        async function saveTestResult(score, type) {
            if (!db || !userId) { console.error("Firestore not ready."); return; }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                await addDoc(collection(db, "artifacts", appId, "users", userId, "cognitiveTests"), {
                    score: score,
                    type: type,
                    createdAt: serverTimestamp()
                });
            } catch (e) { console.error("Error adding document: ", e); }
        }

        async function renderTrendChart() {
            if (!db || !userId) { console.warn("Firestore not ready for chart."); return; }
            const history = [];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const q = query(collection(db, "artifacts", appId, "users", userId, "cognitiveTests"), orderBy("createdAt", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.type === 'user' && data.createdAt) { // Only chart user's self-assessment scores
                    history.unshift({ date: data.createdAt.toDate().toLocaleDateString(), score: data.score });
                }
            });

            const ctx = document.getElementById('trend-chart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            Chart.defaults.color = '#9CA3AF';
            window.myChart = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: history.map(h => h.date), 
                    datasets: [{ 
                        label: 'Score Over Time', 
                        data: history.map(h => h.score), 
                        borderColor: '#38BDF8', 
                        backgroundColor: 'rgba(56, 189, 248, 0.1)', 
                        fill: true, 
                        tension: 0.2,
                        pointBackgroundColor: '#38BDF8',
                        pointRadius: 4
                    }] 
                }, 
                options: { 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            suggestedMax: 30,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#9CA3AF' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9CA3AF' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#D1D5DB'
                            }
                        }
                    }
                } 
            });
        }

        function populateTestSheet() {
            testSheetContent.innerHTML = '';
            const resultsData = testState.user.completed ? testState.user.results.data : testState.family.results.data;
            const isUserTest = testState.user.completed;

            if (!resultsData || resultsData.length === 0) {
                testSheetContent.innerHTML = '<p class="text-gray-400">No test data available.</p>';
                return;
            }

            resultsData.forEach((result, index) => {
                const qaBlock = document.createElement('div');
                qaBlock.className = 'p-4 border border-gray-700 rounded-lg';

                let answerHTML = '';
                if (isUserTest) {
                    answerHTML = `<p class="text-gray-300 mt-2"><span class="font-semibold text-gray-100">Your Answer:</span> ${result.userAnswer || result.transcribedAnswer || 'Not Answered'}</p>`;
                } else { // Observer test
                    answerHTML = `<p class="text-gray-300 mt-2"><span class="font-semibold text-gray-100">Observer's Answer:</span> ${result.observerAnswer}</p>`;
                }

                qaBlock.innerHTML = `
                    <p class="text-gray-400"><span class="font-bold text-gray-200">Q${index + 1}:</span> ${result.question}</p>
                    ${answerHTML}
                `;
                testSheetContent.appendChild(qaBlock);
            });
        }

        function displayResults(data) {
            const t = i18n[selectedLang.split('-')[0]] || i18n.en;
            ['results-title', 'score-p1', 'trend-title', 'status-title', 'feedback-title', 'suggestions-title', 'restart-btn'].forEach(id => document.getElementById(id).textContent = t[id.replace('-','Title').replace('Btn','')]);
            let finalScore = 0;
            if (testState.user.completed) {
                 document.getElementById('score-p1').textContent = "Your Score";
                 finalScore = testState.user.results.score;
            } else if (testState.family.completed) {
                 document.getElementById('score-p1').textContent = "Observer Concern Score";
                 finalScore = testState.family.results.score;
            }
            document.getElementById('score-val').textContent = finalScore;
            document.getElementById('seriousness').textContent = data.seriousness || "No analysis.";
            document.getElementById('feedback').textContent = data.feedback || "No feedback.";
            
            const suggestionsEl = document.getElementById('suggestions');
            if (data.suggestions) {
                if (Array.isArray(data.suggestions)) {
                    suggestionsEl.innerHTML = `<ul class="list-disc list-inside">${data.suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                } else if (typeof data.suggestions === 'string') {
                    suggestionsEl.innerHTML = `<ul class="list-disc list-inside"><li>${data.suggestions}</li></ul>`;
                } else {
                     suggestionsEl.textContent = 'No suggestions available.';
                }
            } else {
                suggestionsEl.textContent = 'No suggestions available.';
            }
            
            document.getElementById('plan-container').classList.add('hidden');
            document.getElementById('plan-content').innerHTML = '';
            document.getElementById('generate-plan-btn').classList.remove('hidden');

            populateTestSheet();
            renderTrendChart();
            showScreen(resultsEl);
        }

        async function callGeminiAPI(prompt) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            let retries = 3, delay = 1000;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) return JSON.parse(jsonText);
                        throw new Error("Invalid API response");
                    }
                    throw new Error(`API Error: ${response.status}`);
                } catch (error) {
                    console.warn(`API call failed, retrying... (${retries - 1} left)`);
                    retries--;
                    if (retries > 0) { await new Promise(res => setTimeout(res, delay)); delay *= 2; } 
                    else throw error;
                }
            }
        }
        
        // --- Web Audio & Visualizer ---
        function setupAudioProcessing(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            visualizerEl.innerHTML = '';
            for(let i = 0; i < 25; i++) {
                const dot = document.createElement('div');
                dot.classList.add('visualizer-dot');
                dot.style.animationDelay = `${i * 0.05}s`;
                visualizerEl.appendChild(dot);
            }
        }
        function visualize(forceActive = false) {
            if (!analyser) return;

            const frame = () => {
                if (!isTestActive && !forceActive) {
                    const dots = document.querySelectorAll('.visualizer-dot');
                    dots.forEach(dot => {
                        if (dot) dot.style.transform = 'scaleY(0.4)';
                    });
                    return;
                }
                if(!analyser) return;
                analyser.getByteFrequencyData(dataArray);
                const dots = document.querySelectorAll('.visualizer-dot');
                const barCount = dots.length;

                if (forceActive) {
                    for (let i = 0; i < barCount; i++) {
                        const scale = 0.4 + (Math.sin(i + Date.now() / 200) + 1) / 2 * 1.2;
                        if (dots[i]) dots[i].style.transform = `scaleY(${scale})`;
                    }
                } else {
                    for (let i = 0; i < barCount; i++) {
                        const dataIndex = Math.floor(i * (dataArray.length / barCount));
                        const value = dataArray[dataIndex];
                        const scale = 0.4 + (value / 255) * 2;
                        if (dots[i]) dots[i].style.transform = `scaleY(${scale})`;
                    }
                }
                requestAnimationFrame(frame);
            }
            frame();
        }
        function stopRecording(shouldConfirm = true) {
            clearTimeout(recordingTimeout);
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (shouldConfirm) {
                // askForConfirmation();
            }
        }
        function startRecording() {
            clearTimeout(silenceTimeout);
            clearTimeout(recordingTimeout);
            audioChunks = [];
            if(mediaRecorder && mediaRecorder.state !== 'recording') {
                mediaRecorder.start();
            }
            visualize();
            
            const currentQuestion = userQuestions.find(q => q.id === askedQuestionIds[askedQuestionIds.length - 1]);
            const duration = (currentQuestion && currentQuestion.id === 11) ? 30000 : null;

            if (duration) {
                recordingTimeout = setTimeout(() => {
                     if (mediaRecorder && mediaRecorder.state === 'recording') {
                        console.log("30-second fruit question timer ended.");
                        stopRecording();
                    }
                }, duration);
            } else {
                 setTimeout(() => {
                    let lastSpeechTime = Date.now();
                    const checkSilence = () => {
                        if (!isTestActive || !mediaRecorder || mediaRecorder.state !== 'recording') return;
                        analyser.getByteFrequencyData(dataArray);
                        if (dataArray.some(v => v > 128)) { lastSpeechTime = Date.now(); }
                        if (Date.now() - lastSpeechTime > 5000) { 
                            stopRecording();
                        } else { 
                            requestAnimationFrame(checkSilence); 
                        }
                    };
                    checkSilence();
                }, 5000);
            }
        }
        
        // --- Gemini TTS Helpers ---
        async function speakWithGeminiTTS(text, langCode) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" };
            
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);
            
            const result = await response.json();
            const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            if (!audioData) throw new Error("No audio data in TTS response.");

            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, 24000); // Gemini TTS returns 24kHz audio
            const audioUrl = URL.createObjectURL(wavBlob);
            
            return new Promise((resolve, reject) => {
                if (!isTestActive) return reject(new Error("Test exited during TTS fetch."));
                currentAudioPlayer = new Audio(audioUrl);
                currentAudioPlayer.onended = () => { currentAudioPlayer = null; resolve(); };
                currentAudioPlayer.onerror = (e) => { currentAudioPlayer = null; reject(new Error("Audio playback error: " + e)); };
                currentAudioPlayer.play();
            });
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * bitsPerSample / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT;

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            const wavBytes = new Uint8Array(44 + dataSize);
            wavBytes.set(new Uint8Array(header), 0);
            wavBytes.set(new Uint8Array(pcmData.buffer), 44);

            return new Blob([wavBytes], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Scroll Animation Logic
        const scrollSections = document.querySelectorAll("[data-scroll-section]");
        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("is-visible");
                    } else {
                        entry.target.classList.remove("is-visible");
                    }
                });
            },
            { threshold: 0.1 }
        );

        scrollSections.forEach((section) => {
            observer.observe(section);
        });
        
        // Video Scroll Logic
        let videoFrame;
        bgVideo.src = '285357.mp4';
        bgVideo.addEventListener('loadedmetadata', () => {
          bgVideo.currentTime = 0;
          bgVideo.pause();

          window.addEventListener('scroll', () => {
             cancelAnimationFrame(videoFrame);
             videoFrame = requestAnimationFrame(updateVideoTime);
          }, { passive: true });
        });
        
        function updateVideoTime() {
            const scrollableHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollFraction = window.scrollY / scrollableHeight;
            
            if (bgVideo.duration && isFinite(bgVideo.duration)) {
              const targetTime = bgVideo.duration * scrollFraction;
              // Smoothly interpolate current time towards target time
              bgVideo.currentTime += (targetTime - bgVideo.currentTime) * 0.1;
            }
        }


    </script>
</body>
</html>